{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block page_subtitle %}
<p class="text-muted mb-0">
    Overview of collections, expenses, bank and cash in hand. Use filters to see specific date ranges.
</p>
{% endblock %}

{% block content %}

<style>
    /* === Summary cards (top row) === */
    .stat-card {
        border: none;
        border-radius: 16px;
        overflow: hidden;
        position: relative;
    }

    .stat-card .card-body {
        padding: 16px 18px;
    }

    .stat-icon-wrap {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #ffffff;
        margin-right: 8px;
    }

    .stat-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: rgba(15,23,42,0.65);
        margin-bottom: 3px;
    }

    .stat-value {
        font-size: 22px;
        font-weight: 600;
        color: #0f172a;
    }

    .stat-sub {
        font-size: 12px;
        color: #6b7280;
    }

    .card-collection {
        background: linear-gradient(135deg, #e0f2fe, #dbeafe);
    }
    .card-expense {
        background: linear-gradient(135deg, #fef9c3, #fee2e2);
    }
    .card-cash {
        background: linear-gradient(135deg, #dcfce7, #a7f3d0);
    }
    .card-bank {
        background: linear-gradient(135deg, #ede9fe, #dbeafe);
    }

    /* === Tables & cards === */
    .card {
        border-radius: 16px;
        border: 1px solid #e5e7eb;
    }

    .card-header {
        border-bottom-color: #e5e7eb;
        background: #f9fafb;
    }

    .table thead th {
        background: #f3f4f6;
        border-bottom-width: 1px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: .06em;
        color: #6b7280;
    }

    .table tbody tr:hover {
        background: #f9fafb;
    }

    .table td {
        font-size: 13px;
    }

    .filter-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: .06em;
        color: #9ca3af;
    }

    .badge-soft {
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
        background: #e5e7eb;
        color: #374151;
    }

    .card-footer {
        background: #f9fafb;
        border-top-color: #e5e7eb;
    }
</style>

<div class="row g-3 mb-3">
    <!-- Total Collection (range: Recent Days filter) -->
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card card-collection shadow-sm h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="stat-label">Collection (Selected Range)</div>
                    <div class="stat-value">
                        {{ "%.2f"|format(total_collection_range or 0) }} ৳
                    </div>
                    <div class="stat-sub">
                        {{ days_start.strftime("%d/%m/%Y") }} — {{ days_end.strftime("%d/%m/%Y") }}
                    </div>
                </div>
                <div class="stat-icon-wrap" style="background:#0ea5e9;">
                    <i class="bi bi-cash-coin"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Month Expenses -->
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card card-expense shadow-sm h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="stat-label">Expenses (Current Month)</div>
                    <div class="stat-value">
                        {{ "%.2f"|format(total_expenses_month or 0) }} ৳
                    </div>
                </div>
                <div class="stat-icon-wrap" style="background:#f97316;">
                    <i class="bi bi-receipt"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash in Hand -->
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card card-cash shadow-sm h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="stat-label">Cash in Hand</div>
                    <div class="stat-value">
                        {{ "%.2f"|format(cash_in_hand or 0) }} ৳
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bank Balance -->
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card card-bank shadow-sm h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="stat-label">Bank Balance</div>
                    <div class="stat-value">
                        {{ "%.2f"|format(bank_balance or 0) }} ৳
                    </div>
                </div>
                <div class="stat-icon-wrap" style="background:#6366f1;">
                    <i class="bi bi-bank"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">

    <!-- ===========================
         RECENT DAYS (COLLECTIONS)
    ============================ -->
    <div class="col-lg-7">
        <div class="card mb-3 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>Recent Days – Collections</strong>
                    <div class="small text-muted">
                        Default shows current month. Use date range to change.
                    </div>
                </div>
                <form class="d-flex align-items-end gap-2" method="get" action="{{ url_for('dashboard') }}">
                    <div>
                        <label class="filter-label mb-0">From</label>
                        <input type="date" name="days_start" class="form-control form-control-sm"
                               value="{{ days_start.strftime('%Y-%m-%d') }}">
                    </div>
                    <div>
                        <label class="filter-label mb-0">To</label>
                        <input type="date" name="days_end" class="form-control form-control-sm"
                               value="{{ days_end.strftime('%Y-%m-%d') }}">
                    </div>
                    {# preserve expense range when submitting this form #}
                    <input type="hidden" name="exp_start" value="{{ exp_start.strftime('%Y-%m-%d') }}">
                    <input type="hidden" name="exp_end" value="{{ exp_end.strftime('%Y-%m-%d') }}">
                    <button class="btn btn-sm btn-outline-primary mt-3" type="submit">
                        Apply
                    </button>
                </form>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0 align-middle">
                        <thead>
                        <tr>
                            <th>Date</th>
                            <th class="text-end">New</th>
                            <th class="text-end">Old</th>
                            <th class="text-end">Total</th>
                            <th class="text-end">Lab</th>
                            <th>Notes</th>
                            <th>Added By</th>
                            {% if g.user.role == 'admin' %}
                                <th class="text-end">Action</th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody>
                        {% if days %}
                            {% for d in days %}
                            <tr>
                                <td>
                                    <span class="badge-soft">
                                        {{ d.date.strftime("%Y-%m-%d") }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    {{ "%.2f"|format(d.collect_soft_new or 0) }}
                                </td>
                                <td class="text-end">
                                    {{ "%.2f"|format(d.collect_soft_old or 0) }}
                                </td>
                                <td class="text-end fw-semibold">
                                    {{ "%.2f"|format(d.total_collection or 0) }}
                                </td>
                                <td class="text-end">
                                    {% set lab = lab_by_date.get(d.date) %}
                                    {{ "%.2f"|format(lab.amount) if lab else "0.00" }}
                                </td>
                                <td style="max-width: 220px;">
                                    {{ d.notes }}
                                </td>
                                <td>
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary">
                                        {{ d.created_by.username if d.created_by else '—' }}
                                    </span>
                                </td>
                                {% if g.user.role == 'admin' %}
                                <td class="text-end">
                                    <form method="post"
                                          action="{{ url_for('delete_day', day_id=d.id) }}"
                                          onsubmit="return confirm('Delete this day summary?');">
                                        <!-- Delete button intentionally hidden / commented -->
                                    </form>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-3">
                                    No day summaries found in this range.
                                </td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer text-end small text-muted">
                Total (range) = {{ "%.2f"|format(total_collection_range or 0) }} ৳
                (including Lab collections)
            </div>
        </div>
    </div>

    <!-- ===========================
         EXPENSES TABLE
    ============================ -->
    <div class="col-lg-5">
        <div class="card mb-3 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>Expenses</strong>
                    <div class="small text-muted">
                        Default shows current day. Use date range to change.
                    </div>
                </div>
                <form class="d-flex align-items-end gap-2" method="get" action="{{ url_for('dashboard') }}">
                    <div>
                        <label class="filter-label mb-0">From</label>
                        <input type="date" name="exp_start" class="form-control form-control-sm"
                               value="{{ exp_start.strftime('%Y-%m-%d') }}">
                    </div>
                    <div>
                        <label class="filter-label mb-0">To</label>
                        <input type="date" name="exp_end" class="form-control form-control-sm"
                               value="{{ exp_end.strftime('%Y-%m-%d') }}">
                    </div>
                    {# preserve days range when submitting this form #}
                    <input type="hidden" name="days_start" value="{{ days_start.strftime('%Y-%m-%d') }}">
                    <input type="hidden" name="days_end" value="{{ days_end.strftime('%Y-%m-%d') }}">
                    <button class="btn btn-sm btn-outline-primary mt-3" type="submit">
                        Apply
                    </button>
                </form>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0 align-middle">
                        <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th class="text-end">Amount (৳)</th>
                            <th>By</th>
                            {% if g.user.role == 'admin' %}
                                <th class="text-end">Action</th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody>
                        {% if expenses %}
                            {% for e in expenses %}
                            <tr>
                                <td>
                                    <span class="badge-soft">
                                        {{ e.date.strftime("%Y-%m-%d") }}
                                    </span>
                                </td>
                                <td>{{ e.category }}</td>
                                <td style="max-width: 180px;">
                                    {{ e.description }}
                                </td>
                                <td class="text-end fw-semibold">
                                    {{ "%.2f"|format(e.amount or 0) }}
                                </td>
                                <td>
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary" style="font-size: 10px;">
                                        {{ e.created_by.username if e.created_by else '—' }}
                                    </span>
                                </td>
                                {% if g.user.role == 'admin' %}
                                <td class="text-end">
                                    <form method="post"
                                          action="{{ url_for('delete_expense', expense_id=e.id) }}"
                                          onsubmit="return confirm('Delete this expense?');">
                                        <button type="submit"
                                                class="btn btn-sm btn-outline-danger">
                                            Delete
                                        </button>
                                    </form>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-3">
                                    No expenses found in this range.
                                </td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {# Doctor bills block kept commented as in your original #}
    </div>

</div>

{% endblock %}
